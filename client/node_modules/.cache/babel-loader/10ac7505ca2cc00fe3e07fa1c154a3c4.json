{"ast":null,"code":"var _jsxFileName = \"/home/hoangnd/Documents/hust/20202/project/livestream/client/src/pages/broadcaster.page.js\";\nimport React from \"react\";\nimport io from 'socket.io-client';\nimport './styles/broadcaster.style.css';\nimport configs from '../config';\nimport authService from \"../services/auth.service\";\nimport NavBar from \"../components/navbar.component\";\nimport ChatContainer from \"../components/chat.component\";\nimport '../../node_modules/font-awesome/css/font-awesome.min.css';\nimport { Dropdown } from \"react-bootstrap\";\nimport DropdownToggle from \"react-bootstrap/esm/DropdownToggle\";\nimport DropdownMenu from \"react-bootstrap/esm/DropdownMenu\";\nimport DropdownItem from \"react-bootstrap/esm/DropdownItem\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nclass BroadCaster extends React.Component {\n  constructor() {\n    super(); // check if user did not sign in\n\n    this.CommitMessage = message => {\n      this.state.socket.emit(\"chat\", message, this.state.user.name, this.state.socket.id);\n      this.setState({\n        messageList: [...this.state.messageList, {\n          time: new Date(),\n          message: message,\n          user: this.state.user.name\n        }]\n      });\n    };\n\n    this.SwitchShare = mode => {\n      if (mode === 1 && this.state.shareMode === 0) {\n        // using camera\n        // change camera to screen\n        navigator.mediaDevices.getDisplayMedia(configs.VIDEO_CONSTRAINS).then(stream => {\n          document.querySelector(\"video\").srcObject = stream;\n\n          for (const [, peer] of Object.entries(this.state.peerConnections)) {\n            peer.getSenders().forEach(rtpSender => {\n              if (rtpSender.track.kind === 'video') {\n                rtpSender.replaceTrack(stream.getTracks()[0]).then(function () {\n                  console.log(\"Replaced video track from camera to screen\");\n                }).catch(function (error) {\n                  console.log(\"Could not replace video track: \" + error);\n                });\n              }\n            });\n          }\n        }).catch(error => console.error(error));\n        this.setState({\n          shareMode: 1 - this.state.shareMode\n        });\n      } else if (mode === 0 && this.state.shareMode === 1) {\n        // change screen to camera\n        navigator.mediaDevices.getUserMedia(configs.VIDEO_CONSTRAINS).then(stream => {\n          document.querySelector(\"video\").srcObject = stream;\n\n          for (const [, peer] of Object.entries(this.state.peerConnections)) {\n            peer.getSenders().forEach(rtpSender => {\n              if (rtpSender.track.kind === 'video') {\n                console.log(234234234);\n                rtpSender.replaceTrack(stream.getVideoTracks()[0]).then(function () {\n                  console.log(\"Replaced video track from screen to camera\");\n                }).catch(function (error) {\n                  console.log(\"Could not replace video track: \" + error);\n                });\n              }\n            });\n          }\n        }).catch(error => console.error(error));\n        this.setState({\n          shareMode: 1 - this.state.shareMode\n        });\n      }\n    };\n\n    let user = authService.getCurrentUser();\n\n    if (!user) {\n      this.props.history.push('/login');\n      window.location.reload();\n    }\n\n    this.state = {\n      // client list\n      peerConnections: {},\n      // socket connection\n      socket: io(`${configs.API_URL}`),\n      user: JSON.parse(user),\n      messageList: [],\n      password: '',\n      shareMode: 0 // 0 => camera, 1 => screen\n\n    };\n  }\n\n  componentDidMount() {\n    document.getElementById('dropdown_switch').classList.remove('dropdown-toggle'); // Use camera\n\n    navigator.mediaDevices.getUserMedia(configs.VIDEO_CONSTRAINS).then(stream => {\n      document.querySelector(\"video\").srcObject = stream;\n      this.state.socket.emit(\"broadcaster\", this.state.user.name, this.props.mode);\n    }).catch(error => console.error(error)); // Use screen\n    // navigator.mediaDevices\n    //     .getDisplayMedia(configs.VIDEO_CONSTRAINS)\n    //     .then(stream => {\n    //         document.querySelector(\"video\").srcObject = stream;\n    //         this.state.socket.emit(\"broadcaster\", this.state.user.name, this.props.mode);\n    //     })\n    //     .catch(error => console.error(error));\n    // Socket handler\n\n    this.state.socket.on(\"start-watching\", clientId => {\n      const peerConnection = new RTCPeerConnection(configs.STUN_CONFIG); // update state\n\n      this.setState(prevState => {\n        let newPeerConnections = prevState.peerConnections;\n        newPeerConnections[clientId] = peerConnection;\n        return {\n          socket: this.state.socket,\n          peerConnections: newPeerConnections\n        };\n      });\n      let stream = document.querySelector(\"video\").srcObject;\n      stream.getTracks().forEach(track => {\n        peerConnection.addTrack(track, stream);\n      });\n\n      peerConnection.onicecandidate = event => {\n        if (event.candidate) {\n          this.state.socket.emit(\"candidate\", clientId, event.candidate);\n        }\n      };\n\n      peerConnection.createOffer().then(sdp => peerConnection.setLocalDescription(sdp)).then(() => {\n        this.state.socket.emit(\"offer\", clientId, peerConnection.localDescription);\n      });\n    });\n    this.state.socket.on(\"password\", password => {\n      console.log(password);\n      this.setState({\n        password: password\n      });\n    });\n    this.state.socket.on(\"answer\", (id, description) => {\n      this.state.peerConnections[id].setRemoteDescription(description);\n    });\n    this.state.socket.on(\"candidate\", (id, candidate) => {\n      this.state.peerConnections[id].addIceCandidate(new RTCIceCandidate(candidate));\n    });\n    this.state.socket.on(\"chat\", (watcherName, message) => {\n      this.setState({\n        messageList: [...this.state.messageList, {\n          time: new Date(),\n          message: message,\n          user: watcherName\n        }]\n      });\n    });\n    this.state.socket.on(\"disconnectPeer\", id => {\n      this.state.peerConnections[id].close();\n      delete this.state.peerConnections[id];\n    });\n\n    window.onunload = window.onbeforeunload = () => {\n      this.state.socket.close();\n    };\n  }\n\n  render() {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(NavBar, {\n        password: this.state.password,\n        user: this.state.user,\n        history: this.props.history,\n        isStreaming: true\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 192,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(Dropdown, {\n        children: [/*#__PURE__*/_jsxDEV(DropdownToggle, {\n          id: \"dropdown_switch\",\n          children: /*#__PURE__*/_jsxDEV(\"i\", {\n            className: \"fa fa-cog\",\n            \"aria-hidden\": \"true\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 195,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 194,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(DropdownMenu, {\n          children: [/*#__PURE__*/_jsxDEV(DropdownItem, {\n            onClick: () => this.SwitchShare(0),\n            children: \"Camera\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 198,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(DropdownItem, {\n            onClick: () => this.SwitchShare(1),\n            children: \"Screen\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 199,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 197,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 193,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"row\",\n        style: {\n          margin: '0'\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          id: \"stream-screen\",\n          className: \"col-md-9\",\n          style: {\n            textAlign: 'center',\n            backgroundColor: 'black',\n            margin: '0'\n          },\n          children: /*#__PURE__*/_jsxDEV(\"video\", {\n            id: \"camera\",\n            playsInline: true,\n            autoPlay: true,\n            muted: true\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 204,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 203,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"col-md-3\",\n          style: {\n            margin: '0',\n            padding: '0'\n          },\n          children: /*#__PURE__*/_jsxDEV(ChatContainer, {\n            currentUser: this.state.user.name,\n            messageList: this.state.messageList,\n            commitMessage: this.CommitMessage\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 207,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 206,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 202,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 191,\n      columnNumber: 13\n    }, this);\n  }\n\n}\n\nexport default BroadCaster;","map":{"version":3,"sources":["/home/hoangnd/Documents/hust/20202/project/livestream/client/src/pages/broadcaster.page.js"],"names":["React","io","configs","authService","NavBar","ChatContainer","Dropdown","DropdownToggle","DropdownMenu","DropdownItem","BroadCaster","Component","constructor","CommitMessage","message","state","socket","emit","user","name","id","setState","messageList","time","Date","SwitchShare","mode","shareMode","navigator","mediaDevices","getDisplayMedia","VIDEO_CONSTRAINS","then","stream","document","querySelector","srcObject","peer","Object","entries","peerConnections","getSenders","forEach","rtpSender","track","kind","replaceTrack","getTracks","console","log","catch","error","getUserMedia","getVideoTracks","getCurrentUser","props","history","push","window","location","reload","API_URL","JSON","parse","password","componentDidMount","getElementById","classList","remove","on","clientId","peerConnection","RTCPeerConnection","STUN_CONFIG","prevState","newPeerConnections","addTrack","onicecandidate","event","candidate","createOffer","sdp","setLocalDescription","localDescription","description","setRemoteDescription","addIceCandidate","RTCIceCandidate","watcherName","close","onunload","onbeforeunload","render","margin","textAlign","backgroundColor","padding"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport io from 'socket.io-client'\nimport './styles/broadcaster.style.css'\nimport configs from '../config'\nimport authService from \"../services/auth.service\";\nimport NavBar from \"../components/navbar.component\";\nimport ChatContainer from \"../components/chat.component\";\nimport '../../node_modules/font-awesome/css/font-awesome.min.css';\nimport { Dropdown } from \"react-bootstrap\";\nimport DropdownToggle from \"react-bootstrap/esm/DropdownToggle\";\nimport DropdownMenu from \"react-bootstrap/esm/DropdownMenu\";\nimport DropdownItem from \"react-bootstrap/esm/DropdownItem\";\n\nclass BroadCaster extends React.Component {\n    constructor() {\n        super()\n\n        // check if user did not sign in\n        let user = authService.getCurrentUser();\n        if (!user) {\n            this.props.history.push('/login')\n            window.location.reload()\n        }\n\n        this.state = {\n            // client list\n            peerConnections: {},\n            // socket connection\n            socket: io(`${configs.API_URL}`),\n            user: JSON.parse(user),\n            messageList: [],\n            password: '',\n            shareMode: 0 // 0 => camera, 1 => screen\n        }\n    }\n\n    componentDidMount() {\n        document.getElementById('dropdown_switch').classList.remove('dropdown-toggle');\n\n        // Use camera\n        navigator.mediaDevices\n            .getUserMedia(configs.VIDEO_CONSTRAINS)\n            .then(stream => {\n                document.querySelector(\"video\").srcObject = stream;\n                this.state.socket.emit(\"broadcaster\", this.state.user.name, this.props.mode);\n            })\n            .catch(error => console.error(error));\n\n        // Use screen\n        // navigator.mediaDevices\n        //     .getDisplayMedia(configs.VIDEO_CONSTRAINS)\n        //     .then(stream => {\n        //         document.querySelector(\"video\").srcObject = stream;\n        //         this.state.socket.emit(\"broadcaster\", this.state.user.name, this.props.mode);\n        //     })\n        //     .catch(error => console.error(error));\n\n        // Socket handler\n        this.state.socket.on(\"start-watching\", clientId => {\n            const peerConnection = new RTCPeerConnection(configs.STUN_CONFIG);\n\n            // update state\n            this.setState(prevState => {\n                let newPeerConnections = prevState.peerConnections\n                newPeerConnections[clientId] = peerConnection\n                return {\n                    socket: this.state.socket,\n                    peerConnections: newPeerConnections\n                }\n            })\n\n            let stream = document.querySelector(\"video\").srcObject;\n            stream.getTracks().forEach(track => {\n                peerConnection.addTrack(track, stream)\n            });\n\n            peerConnection.onicecandidate = event => {\n                if (event.candidate) {\n                    this.state.socket.emit(\"candidate\", clientId, event.candidate);\n                }\n            };\n\n            peerConnection\n                .createOffer()\n                .then(sdp => peerConnection.setLocalDescription(sdp))\n                .then(() => {\n                    this.state.socket.emit(\"offer\", clientId, peerConnection.localDescription);\n                });\n        });\n\n        this.state.socket.on(\"password\", (password) => {\n            console.log(password)\n            this.setState({\n                password: password\n            })\n        });\n\n        this.state.socket.on(\"answer\", (id, description) => {\n            this.state.peerConnections[id].setRemoteDescription(description);\n        });\n\n        this.state.socket.on(\"candidate\", (id, candidate) => {\n            this.state.peerConnections[id].addIceCandidate(new RTCIceCandidate(candidate));\n        });\n\n        this.state.socket.on(\"chat\", (watcherName, message) => {\n            this.setState({\n                messageList: [...this.state.messageList, {\n                    time: new Date(),\n                    message: message,\n                    user: watcherName\n                }]\n            })\n        });\n\n        this.state.socket.on(\"disconnectPeer\", id => {\n            this.state.peerConnections[id].close();\n            delete this.state.peerConnections[id];\n        });\n\n        window.onunload = window.onbeforeunload = () => {\n            this.state.socket.close();\n        };\n    }\n\n    CommitMessage = (message) => {\n        this.state.socket.emit(\"chat\", message, this.state.user.name, this.state.socket.id)\n        this.setState({\n            messageList: [...this.state.messageList, {\n                time: new Date(),\n                message: message,\n                user: this.state.user.name\n            }]\n        })\n    }\n\n    SwitchShare = (mode) => {\n        if (mode === 1 && this.state.shareMode === 0) { // using camera\n            // change camera to screen\n            navigator.mediaDevices\n                .getDisplayMedia(configs.VIDEO_CONSTRAINS)\n                .then(stream => {\n                    document.querySelector(\"video\").srcObject = stream;\n                    for (const [, peer] of Object.entries(this.state.peerConnections)) {\n                        peer.getSenders().forEach(rtpSender => {\n                            if (rtpSender.track.kind === 'video') {\n                                rtpSender.replaceTrack(stream.getTracks()[0]).then(function () {\n                                    console.log(\"Replaced video track from camera to screen\");\n                                }).catch(function (error) {\n                                    console.log(\"Could not replace video track: \" + error);\n                                });\n                            }\n                        });\n                    }\n                })\n                .catch(error => console.error(error));\n\n            this.setState({\n                shareMode: 1 - this.state.shareMode\n            })\n        }\n        else if (mode === 0 && this.state.shareMode === 1) {\n            // change screen to camera\n            navigator.mediaDevices\n                .getUserMedia(configs.VIDEO_CONSTRAINS)\n                .then(stream => {\n                    document.querySelector(\"video\").srcObject = stream;\n                    for (const [, peer] of Object.entries(this.state.peerConnections)) {\n                        peer.getSenders().forEach(rtpSender => {\n                            if (rtpSender.track.kind === 'video') {\n                                console.log(234234234);\n                                rtpSender.replaceTrack(stream.getVideoTracks()[0]).then(function () {\n                                    console.log(\"Replaced video track from screen to camera\");\n                                }).catch(function (error) {\n                                    console.log(\"Could not replace video track: \" + error);\n                                });\n                            }\n                        });\n                    }\n                })\n                .catch(error => console.error(error));\n\n            this.setState({\n                shareMode: 1 - this.state.shareMode\n            })\n        }\n    }\n\n    render() {\n        return (\n            <div>\n                <NavBar password={this.state.password} user={this.state.user} history={this.props.history} isStreaming={true} />\n                <Dropdown>\n                    <DropdownToggle id='dropdown_switch'>\n                        <i className=\"fa fa-cog\" aria-hidden=\"true\"></i>\n                    </DropdownToggle>\n                    <DropdownMenu>\n                        <DropdownItem onClick={() => this.SwitchShare(0)}>Camera</DropdownItem>\n                        <DropdownItem onClick={() => this.SwitchShare(1)}>Screen</DropdownItem>\n                    </DropdownMenu>\n                </Dropdown>\n                <div className='row' style={{ margin: '0' }}>\n                    <div id='stream-screen' className=\"col-md-9\" style={{ textAlign: 'center', backgroundColor: 'black', margin: '0' }}>\n                        <video id='camera' playsInline autoPlay muted></video>\n                    </div>\n                    <div className=\"col-md-3\" style={{ margin: '0', padding: '0' }}>\n                        <ChatContainer currentUser={this.state.user.name} messageList={this.state.messageList} commitMessage={this.CommitMessage} />\n                    </div>\n                </div>\n            </div>\n        )\n    }\n}\n\nexport default BroadCaster;"]},"metadata":{},"sourceType":"module"}